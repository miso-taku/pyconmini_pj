# 要求定義書: 店舗巡回ルート最適化アプリケーション

## 1. プロジェクト概要

### 1.1 目的
駅から近い店舗を検索し、それらを効率的に巡回するための最適ルートを数理最適化によって計算・表示するアプリケーションを開発する。

### 1.2 対象ユーザー
- 複数の店舗を効率的に回りたい徒歩での利用者
- 店舗巡回の計画を立てたい個人

## 2. システム概要

### 2.1 実行環境
- **プラットフォーム**: Jupyter Notebook
- **言語**: Python
- **パッケージマネージャー**: uv

### 2.2 主要機能
1. 駅名と店舗キーワードの入力受付
2. 駅周辺の店舗検索（近い順に10件）
3. 検索結果の表形式表示
4. 検索結果の地図表示
5. 最適巡回ルートの計算（数理最適化）
6. 最適ルートの地図表示

## 3. 機能要件

### 3.1 入力機能

#### 3.1.1 駅名入力
- **入力項目**: 駅名（テキスト）
- **入力形式**: 文字列
- **例**: 「新宿駅」「渋谷」

#### 3.1.2 店舗検索キーワード入力
- **入力項目**: 店舗名または業種・カテゴリ
- **入力形式**: 文字列
- **対応パターン**:
  - 店舗名: 「スターバックス」「セブンイレブン」
  - 業種/カテゴリ: 「カフェ」「コンビニ」「本屋」
  - 混在キーワード: システムが適切に解釈

### 3.2 店舗検索機能

#### 3.2.1 データ取得
- **データソース**: Google Places API
- **取得方法**: リアルタイムAPIリクエスト
- **取得件数**: 駅から近い順に10件
- **距離制限**: なし（近い順に取得）

#### 3.2.2 取得情報
- 店舗名
- 住所
- 緯度・経度座標
- 駅からの距離（徒歩距離）

### 3.3 表示機能

#### 3.3.1 表形式表示
- **形式**: DataFrame または HTMLテーブル
- **表示項目**:
  - 番号（1〜10）
  - 店舗名
  - 住所
  - 駅からの距離
- **ソート**: 駅からの距離が近い順

#### 3.3.2 地図表示（検索結果）
- **地図ライブラリ**: Google Maps API
- **表示要素**:
  - 駅の位置（特別なマーカー）
  - 10件の店舗位置（マーカー）
  - 店舗名のラベル
- **初期表示**: 全マーカーが見える範囲に自動調整

### 3.4 最適化ルート計算機能

#### 3.4.1 最適化手法
- **問題設定**: 巡回セールスマン問題（TSP: Traveling Salesman Problem）
- **開始地点**: 入力された駅
- **訪問地点**: 検索された10件の店舗（全て訪問）
- **終了地点**: 駅に戻る（閉路）
- **最適化目標**: 総移動距離の最小化

#### 3.4.2 使用ライブラリ
- **最適化エンジン**: Python-MIP
- **ソルバー**: CBC（デフォルト）またはその他利用可能なソルバー

#### 3.4.3 距離計算方法
- **移動手段**: 徒歩を想定
- **距離算出**: Google Maps Distance Matrix API または 徒歩経路距離
- **距離行列**: 駅 + 10店舗 = 11地点間の全組み合わせ距離を事前計算

#### 3.4.4 計算制約
- 各店舗は必ず1回ずつ訪問
- 駅から出発し、駅に戻る
- 訪問順序は最適化によって決定

### 3.5 最適ルート表示機能

#### 3.5.1 地図上の表示
- **地図ライブラリ**: Google Maps API
- **表示要素**:
  - 駅マーカー（開始・終了地点）
  - 店舗マーカー（訪問順の番号付き）
  - ルート線（駅 → 店舗1 → 店舗2 → ... → 店舗10 → 駅）
  - 各区間の距離表示（オプション）

#### 3.5.2 ルート詳細情報
- **形式**: 表形式またはリスト
- **表示項目**:
  - 訪問順序（1〜10）
  - 店舗名
  - 前地点からの距離
  - 累積距離
- **集計情報**:
  - 総移動距離
  - 推定所要時間（徒歩速度: 約4km/h）

## 4. 非機能要件

### 4.1 性能要件
- **API応答時間**: Google Places API呼び出し: 5秒以内
- **最適化計算時間**: 10地点のTSP計算: 30秒以内
- **地図描画時間**: 2秒以内

### 4.2 ユーザビリティ
- Jupyter Notebook上で段階的に実行可能
- エラーメッセージは日本語で分かりやすく表示
- 地図は見やすいサイズで表示（推奨: 800x600px以上）

### 4.3 保守性
- コードはモジュール化（関数・クラス単位で分割）
- 各関数にdocstringを記述
- 型ヒントを使用
- PEP 8準拠

## 5. 技術仕様

### 5.1 使用技術スタック

#### 5.1.1 プログラミング言語
- Python 3.10以上

#### 5.1.2 主要ライブラリ
- **地図・位置情報**:
  - `googlemaps`: Google Maps API クライアント
  - `ipywidgets`: Jupyter上でのインタラクティブ表示（オプション）
- **最適化**:
  - `mip`: Python-MIP（数理最適化）
- **データ処理**:
  - `pandas`: データフレーム操作
  - `numpy`: 数値計算
- **可視化**:
  - Google Maps JavaScript API（iframe表示）

#### 5.1.3 外部API
- **Google Places API**: 店舗検索
- **Google Maps Distance Matrix API**: 距離計算
- **Google Maps JavaScript API**: 地図表示

### 5.2 APIキー管理
- 環境変数または設定ファイル（`.env`）で管理
- `.gitignore`でAPIキーファイルを除外
- Notebookには直接記述しない

### 5.3 エラーハンドリング
- API呼び出しエラーの適切な処理
- 店舗が10件未満の場合の対応
- ネットワークエラー時のリトライ機能（オプション）

## 6. データフロー

```
[ユーザー入力]
    ↓
  駅名、店舗キーワード
    ↓
[Google Places API検索]
    ↓
  店舗リスト (10件)
    ↓
[表形式表示] + [地図表示①]
    ↓
[距離行列計算]
  (Google Distance Matrix API)
    ↓
[TSP最適化計算]
  (Python-MIP)
    ↓
  最適ルート
    ↓
[ルート詳細表示] + [地図表示②]
```

## 7. 制約事項・前提条件

### 7.1 前提条件
- Google Cloud Platformアカウントが利用可能
- Google Maps API（Places API、Distance Matrix API、Maps JavaScript API）が有効化済み
- APIキーに適切な制限が設定されている
- インターネット接続が利用可能

### 7.2 制約事項
- Google Maps APIの無料枠制限内での利用を想定
- 検索結果は10件固定（それ以上は取得しない）
- 最適化は厳密解を求める（近似解アルゴリズムは使用しない）
- リアルタイムの交通状況は考慮しない

### 7.3 今後の拡張可能性（スコープ外）
- 訪問店舗数の変更（10件以外）
- 特定店舗の優先順位設定
- 時間制約の考慮（営業時間など）
- 複数の移動手段対応（自転車、車など）
- ルートの手動調整機能
- 結果のエクスポート機能（PDF、画像など）

## 8. 成果物

### 8.1 納品物
- Jupyter Notebook（`.ipynb`ファイル）
- 必要な関数・クラスモジュール（`src/`ディレクトリ）
- `requirements.txt`（依存パッケージリスト）
- `.env.example`（APIキー設定テンプレート）
- README.md（実行手順、使用方法）

### 8.2 ドキュメント
- 本要求定義書
- システム設計書（実装時に作成）
- API仕様書（関数・クラスのdocstring）

## 9. 開発スケジュール（参考）

| フェーズ | 内容 | 備考 |
|---------|------|------|
| Phase 1 | 環境構築・API接続確認 | Google Maps API動作確認 |
| Phase 2 | 店舗検索機能実装 | Places API統合 |
| Phase 3 | 表・地図表示実装 | 検索結果の可視化 |
| Phase 4 | 距離行列計算実装 | Distance Matrix API統合 |
| Phase 5 | TSP最適化実装 | Python-MIPによる最適化 |
| Phase 6 | 最適ルート表示実装 | 地図上のルート描画 |
| Phase 7 | テスト・調整 | 総合テスト、UI改善 |

## 10. 備考

- Google Maps APIの利用には料金が発生する可能性があるため、利用量を監視すること
- API呼び出し回数を最小化するよう設計すること（キャッシュの活用など）
- 本アプリケーションは教育・個人利用を目的としており、商用利用は想定していない
