# 詳細設計書: 店舗巡回ルート最適化Webアプリケーション（Streamlit版）

**バージョン**: 2.0
**最終更新**: 2025-11-07
**対象**: Streamlit Webアプリケーション

---

## 1. システムアーキテクチャ

### 1.1 全体構成

```
┌─────────────────────────────────────────────────────────────┐
│                    ユーザー（ブラウザ）                       │
└─────────────────────────────────────────────────────────────┘
                            ↕ HTTP
┌─────────────────────────────────────────────────────────────┐
│              Streamlit Webサーバー (app.py)                  │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ UIレイヤー (Streamlit Components)                      │ │
│  │  - サイドバー入力                                      │ │
│  │  - メインエリア表示                                    │ │
│  │  - メトリクス表示                                      │ │
│  └────────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ ビジネスロジック層                                     │ │
│  │  - 駅検索                                              │ │
│  │  - 店舗検索                                            │ │
│  │  - 距離行列計算                                        │ │
│  │  - TSP最適化                                           │ │
│  └────────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ データモデル層                                         │ │
│  │  - Location, Place, Station, Route                    │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            ↕ API
┌─────────────────────────────────────────────────────────────┐
│                    Google Maps API群                         │
│  - Geocoding API                                            │
│  - Places API (Nearby Search)                               │
│  - Distance Matrix API                                      │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 ディレクトリ構成

```
pyconmini_pj/
├── app.py                        # Streamlitメインアプリケーション
├── .env                          # APIキー設定（gitignore対象）
├── .env.example                  # APIキー設定テンプレート
├── .gitignore
├── requirements.txt              # 依存パッケージ
├── README.md                     # 実行手順
├── CLAUDE.md                     # Claude Code用設定
├── docs/
│   ├── requirements.md           # 要求定義書
│   ├── design.md                 # Jupyter Notebook版設計書（参考）
│   └── design_streamlit.md       # 本ドキュメント
├── notebooks/
│   └── main.ipynb                # Notebook版（非推奨・参考用）
└── test_*.py                     # デバッグ用テストスクリプト
```

---

## 2. 技術スタック

### 2.1 フレームワーク・ライブラリ

| カテゴリ | ライブラリ | バージョン | 用途 |
|---------|-----------|-----------|------|
| **Webフレームワーク** | Streamlit | >=1.40.0 | UI・インタラクション |
| **Google API** | googlemaps | 4.10.0 | 位置情報・検索・距離計算 |
| **TSP最適化** | mip | >=1.14.0 | 混合整数計画法による数理最適化 |
| **数値計算** | numpy | >=1.26.0 | 距離行列の処理 |
| **データ処理** | pandas | 2.3.3 | テーブル表示 |
| **環境変数** | python-dotenv | 1.0.0 | APIキー管理 |
| **Cバインディング** | cffi | >=2.0.0 | mip依存ライブラリ |

### 2.2 技術的な選定理由

#### Streamlit採用理由
1. **安定性**: Jupyter環境で発生したKernelクラッシュ問題を回避
2. **デプロイ性**: Webアプリとして簡単にデプロイ可能
3. **UI/UX**: リッチなインタラクティブUIを簡単に実装
4. **メンテナンス性**: 単一ファイル構成でコード管理が容易

#### Python-MIP採用理由
1. **厳密解**: 混合整数計画法による厳密な最適解の計算
2. **柔軟性**: 複雑な制約条件を追加可能（MTZ制約など）
3. **パフォーマンス**: CBCソルバーによる高速な求解
4. **スケーラビリティ**: 10〜20地点程度のTSPを実用的な時間で解決
5. **Python統合**: Pythonから直接利用可能、外部ツール不要

---

## 3. データモデル設計

### 3.1 Location（位置情報）

```python
@dataclass
class Location:
    """位置情報を表すクラス"""
    lat: float  # 緯度 (-90 ~ 90)
    lng: float  # 経度 (-180 ~ 180)

    def to_tuple(self) -> Tuple[float, float]:
        """タプル形式に変換（Google Maps API用）"""
        return (self.lat, self.lng)
```

**バリデーション**:
- 緯度: -90 ≤ lat ≤ 90
- 経度: -180 ≤ lng ≤ 180

### 3.2 Station（駅情報）

```python
@dataclass
class Station:
    """駅情報を表すクラス"""
    name: str           # 駅名
    location: Location  # 位置情報

    def to_tuple(self) -> Tuple[float, float]:
        """位置をタプル形式で取得"""
        return self.location.to_tuple()
```

### 3.3 Place（店舗情報）

```python
@dataclass
class Place:
    """店舗情報を表すクラス"""
    place_id: str                          # Google Place ID
    name: str                              # 店舗名
    address: str                           # 住所
    location: Location                     # 位置情報
    distance_from_station: Optional[float] # 駅からの距離（メートル）
```

### 3.4 Route（最適ルート）

```python
@dataclass
class Route:
    """最適化されたルート情報を表すクラス"""
    station: Station              # 出発地点（駅）
    places: List[Place]           # 訪問店舗リスト（最適順序）
    total_distance: float         # 総移動距離（メートル）
    segment_distances: List[float] # 各区間の距離（メートル）

    @property
    def estimated_time(self) -> float:
        """推定所要時間（分）"""
        return (self.total_distance / 1000) / WALKING_SPEED_KM_H * 60
```

---

## 4. 機能設計

### 4.1 駅検索機能

#### 関数: `search_station(station_name: str) -> Station`

**責務**: 駅名から位置情報を取得

**処理フロー**:
```
入力: 駅名（文字列）
  ↓
Google Geocoding API 呼び出し
  ↓
レスポンス検証
  ↓
Station オブジェクト生成
  ↓
出力: Station
```

**API仕様**:
- **エンドポイント**: Google Geocoding API
- **パラメータ**: `address`, `language="ja"`
- **レスポンス**: `{"geometry": {"location": {"lat": ..., "lng": ...}}}`

**エラーハンドリング**:
| エラー | 原因 | メッセージ | 対処 |
|-------|------|-----------|------|
| 駅未検出 | 駅名が存在しない | `'{駅名}' に該当する駅が見つかりませんでした` | 駅名の再入力 |
| APIエラー | 接続・認証エラー | `駅の検索中にエラーが発生しました: {詳細}` | API設定確認 |

### 4.2 店舗検索機能

#### 関数: `search_nearby_places(station: Station, keyword: str, max_results: int) -> List[Place]`

**責務**: 駅周辺の店舗を検索

**処理フロー**:
```
入力: 駅、キーワード、最大件数
  ↓
Google Places API (Nearby Search) 呼び出し
  ↓
結果をPlace オブジェクトに変換
  ↓
出力: Place リスト（駅から近い順）
```

**API仕様**:
- **エンドポイント**: Google Places API (Nearby Search)
- **パラメータ**: `location`, `keyword`, `rank_by="distance"`, `language="ja"`
- **レスポンス**: `{"results": [{"place_id", "name", "vicinity", "geometry": ...}]}`

**制約**:
- 最大検索結果: 3〜20件（UI制限）
- ソート順: 駅からの距離順（近い順）

### 4.3 距離行列計算機能

#### 関数: `calculate_distance_matrix(station: Station, places: List[Place]) -> np.ndarray`

**責務**: 全地点間の徒歩距離を計算

**処理フロー**:
```
入力: 駅、店舗リスト
  ↓
地点リスト構築（駅 + 全店舗）
  ↓
バッチ処理ループ（25地点ごと）
  ├─ Google Distance Matrix API 呼び出し
  └─ 距離行列に値を格納
  ↓
店舗に駅からの距離を設定
  ↓
出力: 距離行列（numpy配列）
```

**API仕様**:
- **エンドポイント**: Google Distance Matrix API
- **パラメータ**: `origins`, `destinations`, `mode="walking"`, `language="ja"`, `units="metric"`
- **制限**: 1リクエストあたり最大 25×25 = 625要素
- **バッチ処理**: 25地点ごとに分割してリクエスト

**距離行列構造**:
```
       駅  店1 店2 店3 ...
駅    [0,  98, 150, 200, ...]
店1   [98,  0,  50, 120, ...]
店2   [150, 50,  0,  80, ...]
店3   [200,120, 80,  0, ...]
...
```

### 4.4 ルート最適化機能

#### 関数: `optimize_route(station: Station, places: List[Place], distance_matrix: np.ndarray) -> Route`

**責務**: TSP（巡回セールスマン問題）として最適ルートを計算

**アルゴリズム**: 混合整数計画法（MIP）
- **ライブラリ**: `mip` (Python-MIP)
- **ソルバー**: CBC（Coin-or Branch and Cut）
- **計算量**: NP困難（指数時間）
- **実用範囲**: 20地点程度まで（30秒以内）

**処理フロー**:
```
入力: 駅、店舗リスト、距離行列
  ↓
MIPモデルの作成
  ↓
決定変数の定義（バイナリ変数 x[i][j]）
  ↓
目的関数の設定（総距離最小化）
  ↓
制約条件の追加
  ├─ 各地点から出る辺は1本
  ├─ 各地点に入る辺は1本
  └─ 部分巡回路除去（MTZ制約）
  ↓
ソルバーで求解（最大30秒）
  ↓
訪問順序の抽出
  ↓
Route オブジェクト構築
  ↓
出力: Route
```

**最適化定式化**:
```
目的関数: min Σ Σ distance[i][j] × x[i][j]
決定変数: x[i][j] ∈ {0,1}  (地点iから地点jへ移動するか)
         u[i] ∈ [1, n-1]  (訪問順序、駅を除く)

制約条件:
  1. Σ x[i][j] = 1  (各地点から出る辺は1本)
  2. Σ x[i][j] = 1  (各地点に入る辺は1本)
  3. u[i] - u[j] + n×x[i][j] ≤ n-1  (MTZ制約：部分巡回路除去)
```

### 4.5 地図表示機能

#### 関数: `generate_google_maps_url(station: Station, places: List[Place], route_order: Optional[List[Place]]) -> str`

**責務**: Google Maps URLを生成

**URL構造**:
```
https://www.google.com/maps/dir/
?api=1
&origin={駅の緯度},{駅の経度}
&destination={最終地点の緯度},{最終地点の経度}
&waypoints={経由地1の緯度},{経由地1の経度}|{経由地2の緯度},...
&travelmode=walking
```

**2つのモード**:
1. **検索結果表示**: 店舗を順不同で表示
2. **最適ルート表示**: 最適化された順序で表示

---

## 5. UI設計

### 5.1 画面構成

```
┌─────────────────────────────────────────────────────────────┐
│ 🗺️ 店舗巡回ルート最適化アプリ                               │
│ 駅周辺の店舗を検索し、最適な巡回ルートを計算します           │
├────────────┬────────────────────────────────────────────────┤
│            │                                                │
│ サイドバー  │              メインエリア                       │
│            │                                                │
│ ┌────────┐ │  ┌──────────────────────────────────────────┐ │
│ │📋 検索条件│ │  │ 処理中表示 / エラー表示                  │ │
│ ├────────┤ │  └──────────────────────────────────────────┘ │
│ │ 駅名    │ │  ┌──────────────────────────────────────────┐ │
│ │ [入力] │ │  │ 📊 検索結果（駅から近い順）              │ │
│ │        │ │  │ ┌──┬─────┬─────────┐              │ │
│ │ キーワード│ │  │ │番号│店舗名│住所     │              │ │
│ │ [入力] │ │  │ └──┴─────┴─────────┘              │ │
│ │        │ │  │ 🗺️ [Google Mapsで開く]                 │ │
│ │ 最大件数│ │  └──────────────────────────────────────────┘ │
│ │ [3-20] │ │  ┌──────────────────────────────────────────┐ │
│ │        │ │  │ 📊 最適ルート詳細                        │ │
│ │ [検索実行]│ │  │ ┌─────┬─────┬─────┐              │ │
│ └────────┘ │  │ │総移動距離│所要時間│訪問店舗数│       │ │
│            │  │ └─────┴─────┴─────┘              │ │
│            │  │ ┌──┬─────┬─────┬─────┐          │ │
│            │  │ │訪問順│店舗名│前地点距離│累積距離│       │ │
│            │  │ └──┴─────┴─────┴─────┘          │ │
│            │  │ 🗺️ [最適ルートをGoogle Mapsで開く]      │ │
│            │  └──────────────────────────────────────────┘ │
└────────────┴────────────────────────────────────────────────┘
```

### 5.2 UIコンポーネント

#### サイドバー（入力エリア）

```python
st.sidebar.header("📋 検索条件")
station_name = st.sidebar.text_input("駅名", value="金山駅")
keyword = st.sidebar.text_input("検索キーワード", value="手羽先")
max_results = st.sidebar.slider("最大検索結果数", min_value=3, max_value=20, value=5)
search_button = st.sidebar.button("🔍 検索・最適化実行", type="primary")
```

#### メインエリア（結果表示）

**1. ステータス表示**
```python
st.info("📍 駅を検索中...")
st.success("✅ 駅の位置情報取得完了")
st.error("❌ エラー: ...")
st.warning("⚠️ 警告: ...")
```

**2. メトリクス表示**
```python
col1, col2, col3 = st.columns(3)
with col1:
    st.metric("総移動距離", "1234m (1.23km)")
with col2:
    st.metric("推定所要時間", "18.5分")
with col3:
    st.metric("訪問店舗数", "5件")
```

**3. テーブル表示**
```python
st.dataframe(df, use_container_width=True)
```

**4. リンク表示**
```python
st.markdown(f"🗺️ [地図をGoogle Mapsで開く]({url})")
```

### 5.3 インタラクションフロー

```
ユーザーアクション                 システム応答
─────────────────────────────────────────────────
1. ページアクセス             → 初期画面表示
2. 駅名・キーワード入力       → リアルタイムバリデーション
3. 「検索・最適化実行」クリック → 処理開始
   ├─ スピナー表示           → 「処理中...」
   ├─ 駅検索                → 「📍 駅を検索中...」
   ├─ 店舗検索              → 「🏪 '{keyword}' を検索中...」
   ├─ 距離計算              → 「📏 距離行列を計算中...」
   └─ ルート最適化          → 「🔧 最適ルートを計算中...」
4. 処理完了                 → 結果表示 + 🎈アニメーション
5. Google Mapsリンククリック → 新しいタブでGoogle Maps表示
```

---

## 6. 処理フロー

### 6.1 メイン処理フロー

```
[アプリ起動]
  ↓
[環境変数読み込み]
  ↓
[APIキー検証]
  ├─ OK → 初期画面表示
  └─ NG → エラー画面 + 停止
  ↓
[ユーザー入力待機]
  ↓
[検索ボタンクリック]
  ↓
[バリデーション]
  ├─ 駅名が空 → 警告表示
  └─ キーワードが空 → 警告表示
  ↓
[処理開始（with st.spinner）]
  ↓
[1. 駅検索]
  ├─ 成功 → 緯度経度取得
  └─ 失敗 → エラー表示 + 終了
  ↓
[2. 店舗検索]
  ├─ 成功 → 店舗リスト取得
  └─ 失敗 → エラー表示 + 終了
  ↓
[3. 検索結果表示]
  ├─ DataFrame表示
  └─ Google Maps URL表示
  ↓
[4. 距離行列計算]
  ├─ バッチ処理（25地点ごと）
  └─ 距離行列生成
  ↓
[5. ルート最適化]
  ├─ TSP求解（Python-MIP）
  └─ Route オブジェクト生成
  ↓
[6. 最適ルート表示]
  ├─ メトリクス表示（3カラム）
  ├─ ルート詳細テーブル
  └─ Google Maps URL表示
  ↓
[7. 完了アニメーション]
  └─ st.balloons()
```

### 6.2 エラーハンドリングフロー

```
[例外発生]
  ↓
[例外の種別判定]
  ├─ ValueError → ユーザーエラー（入力ミスなど）
  │   └─ st.error(f"❌ エラー: {e}")
  │
  └─ Exception → システムエラー
      ├─ st.error(f"❌ 予期しないエラー: {e}")
      └─ トレースバック表示（開発環境）
```

---

## 7. API統合設計

### 7.1 Google Maps API呼び出し一覧

| API | 呼び出し回数 | タイミング | 用途 |
|-----|------------|-----------|------|
| **Geocoding** | 1回/検索 | 駅検索時 | 駅の位置情報取得 |
| **Places Nearby** | 1回/検索 | 店舗検索時 | 周辺店舗の検索 |
| **Distance Matrix** | ⌈(N+1)/25⌉²回/検索 | 距離計算時 | 全地点間距離取得 |

**N**: 店舗数（3〜20件）

**想定API呼び出し回数**:
- 5件検索の場合: 1 + 1 + 1 = **3回**
- 20件検索の場合: 1 + 1 + 1 = **3回**（21地点は1バッチで処理可能）
- 30件検索の場合: 1 + 1 + 4 = **6回**（26地点以上は複数バッチ）

### 7.2 APIレート制限対策

Google Maps APIの無料枠:
- **Geocoding API**: 月40,000リクエスト
- **Places API**: 月40,000リクエスト（Nearbyは1回のリクエストで課金）
- **Distance Matrix API**: 月40,000要素

**推定利用量（月間100回検索想定）**:
- Geocoding: 100リクエスト
- Places: 100リクエスト
- Distance Matrix: 100リクエスト（6地点なら36要素 = 3,600要素/月）

→ **無料枠内で十分運用可能**

---

## 8. セキュリティ設計

### 8.1 APIキー管理

**保存場所**: `.env`ファイル（Gitリポジトリから除外）

```env
GOOGLE_MAPS_API_KEY=AIzaSyXxXxXxXxXxXxXxXxXxXxXxXxXxXxXx
```

**セキュリティ対策**:
1. `.gitignore`に`.env`を追加
2. `.env.example`をテンプレートとして提供
3. アプリ起動時にAPIキーの存在を検証
4. APIキーを画面上に表示しない

### 8.2 入力検証

| 入力項目 | バリデーション | エラー処理 |
|---------|--------------|-----------|
| 駅名 | 空文字チェック | 警告表示 |
| キーワード | 空文字チェック | 警告表示 |
| 最大件数 | 3〜20の範囲 | スライダーで制限 |
| 緯度 | -90〜90 | データクラスで検証 |
| 経度 | -180〜180 | データクラスで検証 |

### 8.3 HTTPS通信

- Google Maps API: すべてHTTPS通信
- Streamlit: ローカル実行時はHTTP、本番環境はHTTPS推奨

---

## 9. パフォーマンス設計

### 9.1 処理時間目標

| 処理 | 目標時間 | 実績（5店舗） |
|------|---------|-------------|
| 駅検索 | <1秒 | 0.5秒 |
| 店舗検索 | <3秒 | 1.5秒 |
| 距離行列計算 | <5秒 | 2.0秒 |
| TSP最適化 | <5秒 | 0.3秒 |
| UI描画 | <1秒 | 0.2秒 |
| **合計** | **<15秒** | **4.5秒** |

### 9.2 最適化手法

1. **バッチ処理**: Distance Matrix APIを25地点ごとにバッチ化
2. **キャッシュ**: Streamlitの`@st.cache_data`デコレータ使用（将来実装）
3. **並列処理**: 複数のAPI呼び出しを並列化（将来実装）
4. **アルゴリズム**: python-tspの動的計画法は15地点程度なら高速

### 9.3 メモリ使用量

| 要素 | サイズ | 備考 |
|-----|--------|------|
| 距離行列（6地点） | 288 bytes | 6×6×8 bytes（float64） |
| Place オブジェクト（5件） | ~2KB | 文字列データ含む |
| DataFrame | ~5KB | pandas内部表現 |
| **合計** | **~10KB** | メモリ効率的 |

---

## 10. テスト設計

### 10.1 ユニットテスト（将来実装）

| テスト対象 | テストケース | 期待結果 |
|-----------|------------|----------|
| `search_station()` | 正常系: "新宿駅" | Station オブジェクト返却 |
| | 異常系: "存在しない駅" | ValueError発生 |
| `search_nearby_places()` | 正常系: "カフェ" | Place リスト返却 |
| | 異常系: 検索結果0件 | ValueError発生 |
| `calculate_distance_matrix()` | 正常系: 5店舗 | 6×6距離行列返却 |
| | バッチ処理: 30店舗 | 31×31距離行列返却 |
| `optimize_route()` | 正常系: 5店舗 | Route オブジェクト返却 |

### 10.2 統合テスト

**テストシナリオ**:

1. **正常系: 金山駅 + 手羽先**
   - 入力: 駅名="金山駅", キーワード="手羽先", 最大件数=5
   - 期待: 5件の店舗が検索され、最適ルートが表示される

2. **正常系: 新宿駅 + カフェ**
   - 入力: 駅名="新宿駅", キーワード="カフェ", 最大件数=10
   - 期待: 10件の店舗が検索され、最適ルートが表示される

3. **異常系: 存在しない駅**
   - 入力: 駅名="存在しない駅", キーワード="ラーメン"
   - 期待: エラーメッセージ表示

4. **異常系: 検索結果0件**
   - 入力: 駅名="東京駅", キーワード="xyzabc123"
   - 期待: エラーメッセージ表示

5. **境界値: 最大20件**
   - 入力: 駅名="渋谷駅", キーワード="レストラン", 最大件数=20
   - 期待: 20件の店舗が検索され、最適ルートが計算される

---

## 11. デプロイ設計

### 11.1 ローカル実行

```bash
# uv環境構築（推奨）
uv venv --python 3.12
source .venv/Scripts/activate  # Unix/Mac: source .venv/bin/activate

# 依存パッケージインストール
uv pip install -r requirements.txt

# 環境変数設定
cp .env.example .env
# .envファイルを編集してAPIキーを設定

# アプリ起動
.venv/Scripts/python -m streamlit run app.py

# または、pipを使用する場合
python -m venv .venv
source .venv/Scripts/activate
pip install -r requirements.txt
streamlit run app.py
```

### 11.2 Streamlit Community Cloud デプロイ（将来実装）

**手順**:
1. GitHubリポジトリにプッシュ
2. [Streamlit Community Cloud](https://streamlit.io/cloud)にログイン
3. リポジトリを接続
4. 環境変数（`GOOGLE_MAPS_API_KEY`）を設定
5. デプロイ

**URL例**: `https://your-app-name.streamlit.app/`

### 11.3 Dockerデプロイ（将来実装）

```dockerfile
FROM python:3.12-slim
WORKDIR /app

# システム依存パッケージのインストール（mipのビルドに必要な場合）
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .
EXPOSE 8501

CMD ["streamlit", "run", "app.py", "--server.port=8501", "--server.address=0.0.0.0"]
```

---

## 12. 運用設計

### 12.1 監視項目

| 項目 | 監視方法 | 閾値 |
|-----|---------|------|
| APIエラー率 | ログ監視 | 5%以上で警告 |
| レスポンス時間 | アクセスログ | 20秒以上で警告 |
| APIクォータ使用量 | Google Cloud Console | 80%以上で警告 |

### 12.2 ログ設計

**ログレベル**:
- `INFO`: 正常処理（検索開始、完了など）
- `WARNING`: 検索結果が少ない、など
- `ERROR`: API呼び出し失敗、最適化失敗など

**ログフォーマット**:
```
[2025-11-07 14:30:15] INFO: 駅検索開始: 金山駅
[2025-11-07 14:30:16] INFO: 駅検索完了: (35.142926, 136.901204)
[2025-11-07 14:30:17] WARNING: 検索結果が3件のみでした
[2025-11-07 14:30:20] ERROR: API呼び出し失敗: timeout
```

### 12.3 バックアップ・復旧

- **設定ファイル**: `.env` のバックアップ
- **コード**: Git リポジトリで管理
- **ユーザーデータ**: なし（ステートレス設計）

---

## 13. 拡張可能性

### 13.1 短期的な拡張（優先度: 高）

1. **キャッシュ機能**
   - Streamlit `@st.cache_data`で検索結果をキャッシュ
   - 同じ駅・キーワードの再検索を高速化

2. **エクスポート機能**
   - ルート結果をCSV/PDFでダウンロード
   - Google Mapsへの共有リンク生成

3. **ユーザー設定**
   - 移動手段の選択（徒歩/自転車/車）
   - 徒歩速度のカスタマイズ

### 13.2 中期的な拡張（優先度: 中）

1. **マルチセッション対応**
   - 複数のルート比較機能
   - ルート履歴の保存・呼び出し

2. **高度な最適化**
   - 営業時間を考慮したルート最適化
   - 訪問時間（滞在時間）の考慮

3. **地図の埋め込み表示**
   - Folium/pydeckで地図をStreamlit内に表示
   - インタラクティブなマーカー操作

### 13.3 長期的な拡張（優先度: 低）

1. **認証・ユーザー管理**
   - ユーザーアカウント機能
   - お気に入りルートの保存

2. **リアルタイム情報**
   - 交通状況の反映
   - 店舗の営業状況確認

3. **モバイルアプリ化**
   - React Native/Flutter でネイティブアプリ化
   - GPSと連動した現在地からのルート案内

---

## 14. 既知の制約・制限事項

### 14.1 技術的制約

1. **TSP計算量**: 20地点を超えると計算時間が長くなる
   - 対策: ユーザーインターフェースで最大20件に制限

2. **API制限**: Google Maps APIの無料枠
   - Geocoding API: 月40,000リクエスト
   - Places API: 月40,000リクエスト
   - Distance Matrix API: 月40,000要素

3. **Streamlit制限**: ブラウザのリロードで状態がリセット
   - 対策: セッションステートで必要なデータを保持（将来実装）

### 14.2 機能的制約

1. **移動手段**: 徒歩のみ（自転車・車は未対応）
2. **検索範囲**: 駅から半径5km程度（Places APIの仕様）
3. **リアルタイム情報**: 交通状況・営業時間は非考慮
4. **多言語対応**: 日本語のみ

---

## 15. トラブルシューティング

### 15.1 よくある問題と対処法

| 問題 | 原因 | 対処法 |
|-----|------|--------|
| APIキーエラー | `.env`未設定 | `.env`ファイルを作成し、APIキーを設定 |
| Streamlit起動エラー | 依存パッケージ未インストール | `pip install -r requirements.txt` |
| 検索結果0件 | キーワードが適切でない | 別のキーワードを試す |
| 最適化に時間がかかる | 店舗数が多すぎる | 最大件数を減らす（15件以下推奨） |
| 地図URLが開かない | ブラウザのポップアップブロック | ポップアップを許可 |

### 15.2 デバッグ方法

**エラーメッセージの確認**:
```python
except Exception as e:
    st.error(f"❌ エラー: {e}")
    import traceback
    st.code(traceback.format_exc())  # トレースバック表示
```

**ログ出力**:
```bash
streamlit run app.py --logger.level=debug
```

---

## 16. 付録

### 16.1 用語集

| 用語 | 説明 |
|-----|------|
| **TSP** | Traveling Salesman Problem（巡回セールスマン問題） |
| **動的計画法** | 部分問題の解を記憶して効率的に解を求めるアルゴリズム |
| **Held-Karp法** | TSPを動的計画法で解くアルゴリズム |
| **Streamlit** | Pythonでデータアプリを構築するフレームワーク |
| **Geocoding** | 住所・地名を緯度経度に変換 |
| **Places API** | 周辺施設の検索 |
| **Distance Matrix API** | 複数地点間の距離・所要時間を取得 |

### 16.2 参考資料

- [Streamlit Documentation](https://docs.streamlit.io/)
- [Google Maps Platform Documentation](https://developers.google.com/maps/documentation)
- [Python-MIP Documentation](https://www.python-mip.com/)
- [NumPy Documentation](https://numpy.org/doc/)
- [Pandas Documentation](https://pandas.pydata.org/docs/)

### 16.3 ライセンス

本アプリケーションはMITライセンスの下で公開されています。

---

## 文書履歴

| 版 | 日付 | 作成者 | 変更内容 |
|----|------|--------|----------|
| 1.0 | 2025-11-07 | Claude Code | Streamlit版の詳細設計書を新規作成 |
| 2.0 | 2025-11-07 | Claude Code | Python-MIP使用への変更、Python 3.12対応、uv環境対応 |

---

**END OF DOCUMENT**
